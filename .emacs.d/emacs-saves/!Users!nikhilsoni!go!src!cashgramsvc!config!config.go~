/* CASHFREE INC. PROPRIETARY AND CONFIDENTIAL
 * ------------------------------------------
 * Copyright (C) Cashfree Inc - All Rights Reserved
 * Unauthorized copying of this file, via any medium is strictly prohibited
 *
 *
 * Author: Nikhil Soni <nikhil@cashfree.com> April, 2019
 */

package config

import (
	"log"
	"os"
	"strings"

	"github.com/spf13/viper"
)

// Config provide required configuration fields from passed file
type Config struct {
	Debug      bool                      `yaml:"debug"`
	Port       string                    `yaml:"port"`
	Stage      string                    `yaml:"stage"`
	Timeout    string                    `yaml:"timeout"`
	SvcBase    svcBase                   `yaml:"svcbase"`
	RateLimits map[string]map[string]int `yaml:"ratelimits"`
}

type svcBase struct {
	Beneficiary    string `yaml:"beneficiary"`
	Transfer       string `yaml:"transfer"`
	BatchTransfer  string `yaml:"batchtransfer"`
	Auth           string `yaml:"auth"`
	Account        string `yaml:"account"`
	Cashgram       string `yaml:"cashgram"`
	BankValidation string `yaml:"bankvalidation"`
	Cache          string `yaml:"cache"`
}

// LoadConfig returns configuration read from file path set in env
func LoadConfig() *Config {
	configPath, _ := os.LookupEnv("PAYOUTAPI_CONFIG")
	if configPath == "" {
		log.Fatalln("Configuration file path not found in PAYOUTAPI_CONFIG.")
	}
	log.Println("Loading configuration from", configPath)

	viper.SetConfigFile(configPath)
	if err := viper.ReadInConfig(); err != nil {
		log.Fatalln("Cannot read config file:", err)
	}
	config := &Config{}
	if err := viper.Unmarshal(config); err != nil {
		log.Fatalln("Cannot decode config file:", err)
	}

	config.RateLimits = loadRateLimits()
	return config
}

// rate limits should ideally come from database not configuration
// Ref: pgapi/config.GetRateLimitsMap
func loadRateLimits() map[string]map[string]int {
	// read rate limits config file
	configPath, _ := os.LookupEnv("PAYOUTAPI_RATE_LIMITS")
	if configPath == "" {
		log.Fatalln("Configuration file path not found in PAYOUTAPI_RATE_LIMITS.")
	}
	log.Println("Loading configuration from", configPath)

	viper.SetConfigFile(configPath)
	if err := viper.ReadInConfig(); err != nil {
		log.Fatalln("Cannot read config file:", err)
	}

	// unmarshalling
	items := viper.AllSettings()
	var rateLimits = make(map[string]map[string]int)
	for id, ratesMap := range items {
		var rateLimit = make(map[string]int)
		if rates, ok := ratesMap.(map[string]interface{}); ok {
			for rateType, val := range rates {
				if rateVal, ok := val.(int); ok {
					rateLimit[strings.ToLower(rateType)] = rateVal
				}
			}
			rateLimits[id] = rateLimit
		}
	}
	return rateLimits
}
