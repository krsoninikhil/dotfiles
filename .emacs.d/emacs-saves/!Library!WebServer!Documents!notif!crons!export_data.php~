<?php

include("globals_bg.inc.php");

$dbHandle =  DbUtil::getHandle();

$limit = 100;
$offset = 0;
$date = 31;
$file = fopen("/tmp/payouts_data.csv", "a");
fwrite($file, "cfTransferId, accountId, cfBankId, amount, transferedOn, cfBeneId, BeneId, bankAccount, vpa, phone, beneAddedOn, accountAddedOn");
fclose($file);


while (true) {
    $fromDate = date("2018-12-{$date} 00:00:00");
    $toDate = date("2018-12-{$date} 23:59:59");

    $q = "select t.id, t.accountId, t.cfBankId, t.amount, t.addedOn, t.cfBeneId, b.beneId, b.bankAccount, b.vpa, b.phone, b.addedOn as beneAddedOn, MPAConfig.addedOn as accountAddedOn from MPATransfers as t, MPABeneficiaries as b, MPAConfig where t.cfBeneId = b.id and MPAConfig.id = t.accountId and t.addedOn >= \"{$fromDate}\" and t.addedOn <= \"{$toDate}\" order by t.id desc limit {$limit} offset {$offset}";
    $param = array();
    $res = $dbHandle->setResultQuery($q, $param);
    // echo $q;
    if (count($res) > 0) {
        echo "\nOffset $offset: ". count($res);
        $file = fopen("/tmp/payouts_data.csv", "a");
        foreach ($res as $row) {
            $row_s = join(",", $row);
            fwrite($file, "\n");
            fwrite($file, $row_s);
        }
        fclose($file);
        $offset += count($res);
    } else {
        if ($date > 1) {
            $date -= 1;
        } else {
            echo "\nDone!";
            break;
        }
    }
}

?>
