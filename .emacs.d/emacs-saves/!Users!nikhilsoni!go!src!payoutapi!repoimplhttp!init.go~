package repoimplhttp

import (
	"bytes"
	"encoding/json"
	"log"
	"net/http"
	"time"
)

type Client struct {
	*http.Client
}

// Init initializes a HTTP client with boilerplate code for requests
func Init() *Client {
	to, _ := time.ParseDuration("30s")
	return &Client{
		&http.Client{Timeout: to},
	}
}

// Get make an HTTP GET request
func (c *Client) Get(uri string, headers map[string][]string) (interface{}, int) {
	req, _ := http.NewRequest(http.MethodGet, uri, nil)
	return c.doRequest(req, headers)
}

// PostJSON add content type header and make an HTTP POST request
func (c *Client) PostJSON(uri string, headers map[string][]string, params interface{}) (interface{}, int) {
	jParams, _ := json.Marshal(params)
	req, _ := http.NewRequest(http.MethodPost, uri, bytes.NewBuffer(jParams))
	headers["Content-Type"] = []string{"application/json"}
	return c.doRequest(req, headers)
}

// Delete make an HTTP DELETE request
func (c *Client) Delete(uri string, headers map[string][]string) (interface{}, int) {
	req, _ := http.NewRequest(http.MethodDelete, uri, nil)
	return c.doRequest(req, headers)
}

func (c *Client) doRequest(req *http.Request, headers map[string][]string) (interface{}, int) {
	req.Header = headers
	res, err := c.Do(req)
	if err != nil {
		log.Println("repoimplhttp#doRequest", err)
		return nil, http.StatusInternalServerError
	}
	defer res.Body.Close()

	var data interface{}
	if err = json.NewDecoder(res.Body).Decode(&data); err != nil {
		return nil, http.StatusInternalServerError
	}
	return data, res.StatusCode
}
