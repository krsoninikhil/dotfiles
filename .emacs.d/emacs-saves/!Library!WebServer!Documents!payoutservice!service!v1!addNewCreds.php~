<?php
  	require (dirname(dirname(dirname(__FILE__))).'/globals.inc.php');
  	require_once(ROOT.'/service/v1/vendor/autoload.php');

    // $gatewayId = 6;
    // $accountId = 1;
    // $kotakservice = [];

    // $kotakservice['endpoint'] = "https://apigwuat.kotak.com:8443/cms_generic_service?wsdl";
    // $kotakservice['clientId'] = "TEMPTEST1";
    // $kotakservice['prodCode'] = "CMSPAY";
    // $kotakservice['debitAccountNo'] = "09582650000173";
    //

    $gatewayId = 7;
    $accountId = 1;
    $config['apiToken'] = "Y29ycHVzZXI6YXhpc2NvcnBjb24xIQ==";
    $config['endpoint'] = "https://qah2h.axisbank.co.in/RESTAdapter/AxisBank/Pasfar";
    $config['appID'] = '54307';
    $config['cmpyCode'] = "AMSL";
    $config['corpCode'] = "DEMOCORP32";
    $config['customerID'] = "SYSTEM";
    $config['debitAccountNo'] = "119010200006828";

    $dbHandle = DbUtil::getHandle();

    createNewCred($config,$gatewayId,$accountId,$dbHandle);

    error_log("here");

    function createNewCred($bankConf,$gatewayId,$accountId,$dbHandle){

        global $CONFIG;
        $cfKey = $CONFIG['payout']['cfKey'];

        $encoded = json_encode($bankConf);
        $enc = encrypt($encoded, $cfKey);

        // deactivateCred($gatewayId,$accountId,$dbHandle);

        error_log($enc);

        $query = "insert into MPAGatewayCreds (accountId, cfGatewayId , creds, isActive) values (?, ?, ?, ?)";

        $param = array("iisi",$accountId,$gatewayId,$enc,1);

        error_log(json_encode($param));
        $result = $dbHandle->setNoResultQuery($query, $param); error_log(json_encode($result));
    }

    function deactivateCred($gatewayId,$accountId,$dbHandle){
        $query = "UPDATE MPAGatewayCreds SET isActive = ? where cfGatewayId = ? AND accountId = ? AND isActive = ?";

        $param = array("iiii","0",$gatewayId,$accountId,"1");

        $result = $dbHandle->setNoResultQuery($query, $param);
    }

    function encrypt($plainText, $cfkey) {
        $cipher = "AES-128-CBC";
        $ivlen = openssl_cipher_iv_length($cipher);
        $iv = openssl_random_pseudo_bytes($ivlen);
        $ciphertext_raw = openssl_encrypt($plainText, $cipher, $cfkey, OPENSSL_RAW_DATA, $iv);
        $hmac = hash_hmac('sha256', $ciphertext_raw, $cfkey, true);
        $ciphertext64 = base64_encode( $iv.$hmac.$ciphertext_raw );
        return $ciphertext64;
    }
?>
